\n <h1 data-hash=\"#构建配置\"><a href=\"#构建配置\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>构建配置</h1><p>从本篇文档开始，我们将介绍 Lavas 构建、运行中使用的配置项。开发者可以在项目根目录下的 <code>lavas.config.js</code> 中定义这些配置项。配置对象的结构大致如下：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div></div><code class=\"lang-javascript\"><span class=\"hljs-comment\">// lavas.config.js</span>\n\n{\n <span class=\"hljs-attr\">build</span>: {},\n <span class=\"hljs-attr\">router</span>: {},\n <span class=\"hljs-attr\">middleware</span>: {},\n <span class=\"hljs-comment\">// 省略其他配置项</span>\n}</code></pre><p>Lavas 内部使用 <a href=\"https://doc.webpack-china.org/concepts/\">Webpack</a> 进行构建，众所周知 Webpack 功能强大但是配置非常复杂，我们隐藏了大部分构建细节，将构建流程中部分常用特性以配置项的形式暴露给用户，便于快速上手。同时，对于高级开发者，也能通过特殊的配置项将自定义的 Loader 和 Plugin 加入构建流程。</p><p>这些在构建过程中使用的 Webpack 相关配置项将放在 <code>build</code> 下，下面我们将依次介绍这些配置项。</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div></div><code class=\"lang-javascript\"><span class=\"hljs-comment\">// lavas.config.js</span>\n\nbuild: {\n <span class=\"hljs-attr\">ssr</span>: <span class=\"hljs-literal\">true</span>,\n <span class=\"hljs-attr\">path</span>: <span class=\"hljs-string\">''</span>,\n <span class=\"hljs-attr\">publicPath</span>: <span class=\"hljs-string\">''</span>,\n <span class=\"hljs-comment\">// 省略其他配置项</span>\n}</code></pre><h2 data-hash=\"#ssr\"><a href=\"#ssr\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>ssr</h2><p>切换 SPA 单页应用和 SSR 服务端渲染两种编译模式。</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">ssr: <span class=\"hljs-literal\">true</span> <span class=\"hljs-comment\">// SSR 模式</span></code></pre><h2 data-hash=\"#path\"><a href=\"#path\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>path</h2><p>最终构建产物的输出地址，必须为绝对路径。如下配置将输出构建产物到 <code>dist</code> 文件夹下：</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">path: path.resolve(__dirname, <span class=\"hljs-string\">'dist'</span>)</code></pre><p>等同于 Webpack 配置中的 <a href=\"https://doc.webpack-china.org/configuration/output/#output-path\">output.path</a>。</p><h2 data-hash=\"#publicpath\"><a href=\"#publicpath\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>publicPath</h2><p>在静态资源路径之前添加的前缀。默认值为 <code>&#39;/&#39;</code>。</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">publicPath: <span class=\"hljs-string\">'/'</span></code></pre><p>例如在使用 CDN 场景下，可以使用如下配置：</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">publicPath: <span class=\"hljs-string\">'//cdn.example.com/assets/'</span></code></pre><p>更多使用例子可参考 Webpack 配置中的 <a href=\"https://doc.webpack-china.org/configuration/output/#output-publicpath\">output.publicPath</a>。</p><h2 data-hash=\"#filenames\"><a href=\"#filenames\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>filenames</h2><p>Webpack 可以指定输出静态资源（JS CSS FONT IMG）的文件名，其中可以使用例如 <code>[hash]</code> 这样的模板字符串。 Lavas 中使用的默认值如下：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div></div><code class=\"lang-javascript\">filenames: {\n <span class=\"hljs-attr\">entry</span>: <span class=\"hljs-string\">'js/[name].[chunkhash:8].js'</span>,\n <span class=\"hljs-attr\">vue</span>: <span class=\"hljs-string\">'js/vue.[chunkhash:8].js'</span>,\n <span class=\"hljs-attr\">vendor</span>: <span class=\"hljs-string\">'js/vendor.[chunkhash:8].js'</span>,\n <span class=\"hljs-attr\">chunk</span>: <span class=\"hljs-string\">'js/[name].[chunkhash:8].js'</span>,\n <span class=\"hljs-attr\">css</span>: <span class=\"hljs-string\">'css/[name].[contenthash:8].css'</span>,\n <span class=\"hljs-attr\">img</span>: <span class=\"hljs-string\">'img/[name].[hash:8].[ext]'</span>,\n <span class=\"hljs-attr\">fonts</span>: <span class=\"hljs-string\">'fonts/[name].[hash:8].[ext]'</span>\n}</code></pre><p>其中：</p><ul><li><strong>entry</strong> entry chunk。将影响各个入口文件名。 可参考 Webpack 中的 <a href=\"https://doc.webpack-china.org/configuration/output/#output-filename\">output.filename</a>。</li><li><strong>vue</strong> 我们将 Vue 相关的依赖合并成一个 chunk。包括 vue、vue-router、vuex 和 vue-meta。</li><li><strong>vendor</strong> 包含其他第三方依赖。</li><li><strong>chunk</strong> async chunk。将影响非入口文件名。可参考 Webpack 中的 <a href=\"https://doc.webpack-china.org/configuration/output/#output-chunkfilename\">output.chunkFilename</a>。</li><li><strong>css</strong> 样式文件。由于使用了 <a href=\"https://doc.webpack-china.org/plugins/extract-text-webpack-plugin\">ExtractTextWebpackPlugin</a>从 JS 中提取样式，必须使用 <code>[contenthash]</code> 而非 <code>[hash]</code> 或者 <code>[chunkhash]</code>。</li><li><strong>img</strong> 图片。</li><li><strong>fonts</strong> 字体文件。</li></ul><p>更多模板字符串示例及其使用场景可以参考 Webpack <a href=\"https://doc.webpack-china.org/configuration/output/#output-filename\">output.filename</a>。</p><h2 data-hash=\"#babel\"><a href=\"#babel\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>babel</h2><p>Lavas 内部配置 Webpack 规则，使用 <code>babel-loader</code> 处理 JS 文件。通过 <code>babel</code> 这个配置项可以指定包括 babel preset 和 plugin 在内的很多属性，更多可配置属性可以参考 <a href=\"https://github.com/babel/babel-loader#options\"><code>babel-loader options</code></a>。</p><p>Lavas 默认使用 <a href=\"https://github.com/vuejs/babel-preset-vue-app\">vue-app</a> 这个 preset，其中已经包含了一系列 babel 插件，在大多数情况下已经能满足 Vue 项目的开发。 但有时我们也需要进行额外的配置，例如在下面使用 <a href=\"https://vuetifyjs.com/\">vuetify</a> 的场景中，我们需要配置一系列 plugins 以支持组件的按需加载功能：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div></div><code class=\"lang-javascript\">babel: {\n <span class=\"hljs-attr\">plugins</span>: [\n <span class=\"hljs-string\">\"transform-runtime\"</span>,\n [<span class=\"hljs-string\">\"transform-imports\"</span>,\n {\n <span class=\"hljs-string\">\"vuetify\"</span>: {\n <span class=\"hljs-string\">\"transform\"</span>: <span class=\"hljs-string\">\"vuetify/es5/components/${member}\"</span>,\n <span class=\"hljs-string\">\"preventFullImport\"</span>: <span class=\"hljs-literal\">true</span>\n }\n }\n ]\n ]\n}</code></pre><h3 data-hash=\"#使用-babelrc\"><a href=\"#使用-babelrc\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>使用 <code>.babelrc</code></h3><p>如果您更习惯使用根目录下的 <code>.babelrc</code> 来配置 <code>babel-loader</code>，您可以手动开启：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div></div><code class=\"lang-javascript\">babel: {\n <span class=\"hljs-attr\">babelrc</span>: <span class=\"hljs-literal\">true</span>\n}</code></pre><p>然后在 <code>.babelrc</code> 中进行配置，例如对于一个 SPA 项目：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div></div><code class=\"lang-json\">{\n <span class=\"hljs-attr\">\"presets\"</span>: [\n <span class=\"hljs-string\">\"vue-app\"</span>,\n {\n <span class=\"hljs-attr\">\"targets\"</span>: {<span class=\"hljs-attr\">\"ie\"</span>: <span class=\"hljs-number\">9</span>, <span class=\"hljs-attr\">\"uglify\"</span>: <span class=\"hljs-literal\">true</span>}\n }\n ],\n <span class=\"hljs-attr\">\"plugins\"</span>: []\n}</code></pre><h2 data-hash=\"#cssextract\"><a href=\"#cssextract\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>cssExtract</h2><p>在使用 <a href=\"https://doc.webpack-china.org/plugins/extract-text-webpack-plugin\">ExtractTextWebpackPlugin</a>从 JS 中提取样式时，需要设置 Loader 和 Plugin。由于分离样式会造成额外的编译开销，Lavas 默认在开发模式中关闭这一特性，在生产环境打开。</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">cssExtract: <span class=\"hljs-literal\">true</span></code></pre><h2 data-hash=\"#cssminimize-csssourcemap\"><a href=\"#cssminimize-csssourcemap\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>cssMinimize &amp; cssSourceMap</h2><p>是否需要对 CSS 文件进行压缩以及生成 source-map。</p><pre><div class=\"code-index\"><div>1</div><div>2</div></div><code class=\"lang-javascript\">cssMinimize: <span class=\"hljs-literal\">true</span>,\n<span class=\"hljs-attr\">cssSourceMap</span>: <span class=\"hljs-literal\">true</span></code></pre><p>这两个参数最终将传递给 <a href=\"https://github.com/webpack-contrib/css-loader\">css-loader</a>。</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div></div><code class=\"lang-javascript\">loader: <span class=\"hljs-string\">'css-loader'</span>,\n<span class=\"hljs-attr\">options</span>: {\n <span class=\"hljs-attr\">minimize</span>: <span class=\"hljs-literal\">true</span>,\n <span class=\"hljs-attr\">sourceMap</span>: <span class=\"hljs-literal\">true</span>\n}</code></pre><h2 data-hash=\"#jssourcemap\"><a href=\"#jssourcemap\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>jsSourceMap</h2><p>是否需要对 JS 文件生成 source-map，便于开发模式调试以及生产环境排查错误，默认开启。</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">jsSourceMap: <span class=\"hljs-literal\">true</span></code></pre><p>Webpack 支持通过 <code>devtool</code> 配置项生成多种 <a href=\"https://doc.webpack-china.org/configuration/devtool/\">source-map</a>。这些不同格式的 source-map 在生成速度，是否内联在源文件中等等方面都有显著差异，需要使用者根据具体场景选择合适的格式。 在开发模式中，由于代码经常发生变动，我们通常会选择生成速度快，可以接受内联从而增加源文件体积的代价。而在生产环境中，我们通常选择生成独立的 source-map 文件，此时生成速度就可以忽略了。</p><p>在 Lavas 中开启这个配置后将作用于以下两种场景：</p><ol><li>开发模式中选择 <code>cheap-module-eval-source-map</code>。这种格式只显示行号不显示列号，重新生成速度很快。</li><li>生产环境中选择 <code>nosources-source-map</code>。这种格式下生成的独立 source-map 不会暴露源文件内容，只会显示错误堆栈信息。同时通过 <a href=\"https://doc.webpack-china.org/plugins/uglifyjs-webpack-plugin\">UglifyJsPlugin</a> 在压缩 JS 文件的同时生成 sourceMap，内部通过设置插件的 <a href=\"https://doc.webpack-china.org/plugins/uglifyjs-webpack-plugin/#sourcemap\">sourcemap 选项</a>实现。</li></ol><h2 data-hash=\"#bundleanalyzerreport\"><a href=\"#bundleanalyzerreport\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>bundleAnalyzerReport</h2><p><a href=\"https://github.com/webpack-contrib/webpack-bundle-analyzer\">Webpack Bundle Analyzer</a> 提供了可视化图表这样的直观方式，帮助开发者分析构建产物中可能出现的问题，例如重复引入、不必要的依赖。</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div></div><code class=\"lang-javascript\"><span class=\"hljs-comment\">// 默认配置，启动 localhost:8888 服务器展示网页</span>\nbundleAnalyzerReport: <span class=\"hljs-literal\">true</span>\n\n<span class=\"hljs-comment\">// 自定义配置</span>\nbundleAnalyzerReport: {\n <span class=\"hljs-attr\">analyzerMode</span>: <span class=\"hljs-string\">'server'</span>,\n <span class=\"hljs-attr\">analyzerHost</span>: <span class=\"hljs-string\">'127.0.0.1'</span>,\n <span class=\"hljs-attr\">analyzerPort</span>: <span class=\"hljs-number\">8888</span>,\n <span class=\"hljs-comment\">// 省略其他配置</span>\n}</code></pre><p>Lavas 默认关闭这一配置。开启后，运行 <code>lavas build</code>，将自动启动服务器并打开网页，以下是 Lavas 模板项目的分析结果： <img src=\"https://gss0.bdstatic.com/9rkZbzqaKgQUohGko9WTAnF6hhy/assets/pwa/projects/1515671916543/bundle-analyzer.png\" alt=\"bundle-analyzer 分析结果\"></p><h2 data-hash=\"#defines\"><a href=\"#defines\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>defines</h2><p>在构建时我们常常需要使用全局常量，在 Webpack 中可以通过 <a href=\"https://doc.webpack-china.org/plugins/define-plugin/\">DefinePlugin</a> 插件定义这些常量。Lavas 提供三组命名空间，分别是 SSR 中服务端使用的 <code>server</code>，客户端使用的 <code>client</code> 以及两者共用的 <code>base</code>。另外需要注意的是常量的值必须包含字符串本身内的实际引号，可以使用单引号包含双引号或者 <code>JSON.stringify()</code>。</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div></div><code class=\"lang-javascript\">defines: {\n <span class=\"hljs-attr\">base</span>: {\n <span class=\"hljs-string\">'MY_CONSTANT'</span>: <span class=\"hljs-string\">'\"VALUE\"'</span>\n },\n <span class=\"hljs-attr\">client</span>: {},\n <span class=\"hljs-attr\">server</span>: {}\n}</code></pre><p>一个常见的使用场景是，需要根据开发环境和生产环境定义不同的 URL。由于在启动 Lavas 时已经设置了环境变量 <code>process.env.NODE_ENV</code>，在 <code>lavas.config.js</code> 中可以这样做：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div></div><code class=\"lang-javascript\"><span class=\"hljs-comment\">// lavas.config.js</span>\n<span class=\"hljs-keyword\">const</span> isProd = process.env.NODE_ENV === <span class=\"hljs-string\">'production'</span>;\n\ndefines: {\n <span class=\"hljs-attr\">base</span>: {\n <span class=\"hljs-attr\">PASSPORT_URL</span>: isProd\n ? <span class=\"hljs-built_in\">JSON</span>.stringify(<span class=\"hljs-string\">'https://wappass.example.com/passport'</span>)\n : <span class=\"hljs-built_in\">JSON</span>.stringify(<span class=\"hljs-string\">'https://wappass.qatest.example.com/passport'</span>)\n }\n}</code></pre><p>另外，Lavas 已经内置了以下两组全局常量 <code>process.env.VUE_ENV</code> 和 <code>process.env.NODE_ENV</code>，可以直接在项目中使用，不需要开发者重复定义：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div></div><code class=\"lang-javascript\"><span class=\"hljs-comment\">// 在同构应用当前处于 client 或者 server 端</span>\n<span class=\"hljs-string\">'process.env.VUE_ENV'</span>: <span class=\"hljs-string\">'\"client\"'</span>,\n\n<span class=\"hljs-comment\">// 当前应用处于开发模式 development 或者生产模式 production</span>\n<span class=\"hljs-string\">'process.env.NODE_ENV'</span>: <span class=\"hljs-string\">'\"development\"'</span></code></pre><h2 data-hash=\"#alias\"><a href=\"#alias\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>alias</h2><p>在 Webpack 中解析模块时，我们常常使用 alias 定义路径的<a href=\"https://doc.webpack-china.org/configuration/resolve/#resolve-alias\">简写别名</a>，便于更加简便地引用模块。</p><p>Lavas 提供了 <code>alias</code> 下三组命名空间，分别是 SSR 中服务端使用的 <code>server</code>，客户端使用的 <code>client</code> 以及两者共用的 <code>base</code>。</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div></div><code class=\"lang-javascript\">alias: {\n <span class=\"hljs-attr\">base</span>: {},\n <span class=\"hljs-attr\">client</span>: {},\n <span class=\"hljs-attr\">server</span>: {}\n}</code></pre><p>另外，Lavas 已经内置了两组别名，开发者不需要重复定义。例如如果想引用项目根目录下 <code>components</code> 文件夹中的组件，只需要使用 <code>import MyComponent from &#39;@/components/MyComponent&#39;</code>：</p><pre><div class=\"code-index\"><div>1</div><div>2</div></div><code class=\"lang-javascript\"><span class=\"hljs-string\">'@'</span>: <span class=\"hljs-string\">''</span> <span class=\"hljs-comment\">// 指向项目根目录,</span>\n<span class=\"hljs-string\">'$'</span>: <span class=\"hljs-string\">''</span> <span class=\"hljs-comment\">// 指向 .lavas 目录</span></code></pre><h2 data-hash=\"#plugins\"><a href=\"#plugins\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>plugins</h2><p>在使用 Webpack 构建时，各种插件是必不可少的，对于开发者自定义的插件，Lavas 提供了 <code>plugins</code> 下三组命名空间，分别是 SSR 中服务端使用的 <code>server</code>，客户端使用的 <code>client</code> 以及两者共用的 <code>base</code>。有一点需要注意，自定义插件将添加到 Lavas 已有插件列表之后，如果对于插件添加顺序有要求，可以参考 <code>extend</code> 配置项，进行更精确的添加。</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div></div><code class=\"lang-javascript\">plugins: {\n <span class=\"hljs-attr\">base</span>: [],\n <span class=\"hljs-attr\">client</span>: [],\n <span class=\"hljs-attr\">server</span>: []\n}</code></pre><h2 data-hash=\"#extend\"><a href=\"#extend\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>extend</h2><p>为了给予开发者更大的灵活度，能自由修改 Webpack 配置对象，Lavas 提供了 <code>extend</code> 方法。 该方法参数说明如下：</p><ul><li><code>config</code> Webpack 配置对象。</li><li><code>options.type</code> Webpack 配置对象类型，一共有三种：<code>client</code> 供客户端使用，<code>server</code> 供服务端使用，<code>base</code> 使两者同时生效。</li><li><code>options.env</code> 当前构建环境变量，取值有两种：<code>development|production</code>。</li></ul><p>例如我们想增加 <code>vue-style-variables-loader</code> 来处理 <code>.vue</code> 文件，可以这么做：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div></div><code class=\"lang-javascript\">extend(config, {type, env}) {\n <span class=\"hljs-comment\">// 在客户端和服务端同时生效，等同于 type === 'client' || type === 'server'</span>\n <span class=\"hljs-keyword\">if</span> (type === <span class=\"hljs-string\">'base'</span>) {\n <span class=\"hljs-keyword\">let</span> vueRule = config.module.rules[<span class=\"hljs-number\">0</span>];\n vueRule.use.push({\n <span class=\"hljs-attr\">loader</span>: <span class=\"hljs-string\">'vue-style-variables-loader'</span>,\n <span class=\"hljs-attr\">options</span>: {\n <span class=\"hljs-attr\">variablesFiles</span>: [\n path.join(__dirname, <span class=\"hljs-string\">'assets/styles/variables.styl'</span>)\n ]\n }\n });\n }\n}</code></pre><blockquote class=\"info\"><p><code>extend</code> 方法适合对于 Webpack 配置对象进行简单扩展的场景，例如添加插件。如果需要对 Lavas 内置的规则和插件进行修改，可以参考下面的 <code>extendByWebpackChain</code> 方法。</p></blockquote><h2 data-hash=\"#extendwithwebpackchain\"><a href=\"#extendwithwebpackchain\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>extendWithWebpackChain</h2><blockquote class=\"info\"><p>该方法在 <a href=\"mailto:lavas-core-vue@1.0.8\">lavas-core-vue@1.0.8</a> 版本引入，同时由于使用了 webpack-chain 依赖，要求 Node 版本 &gt; 6.9.0。</p></blockquote><p>使用上面提到的 <code>extend</code> 方法直接修改 Webpack 配置对象，对于熟悉 Webpack 文档的开发者会比较直观。但是在以下场景下存在局限性：</p><ol><li><strong>修改 Lavas 已有规则</strong>。由于 Webpack 配置对象层次很深，尤其是访问数组类型的配置项时只能以索引方式。例如 Lavas 内置了 vue-loader 处理 <code>.vue</code> 文件，如果使用 <code>extend</code> 方法试图访问并修改，只能通过 <code>config.module.rules[0].use[0].options.loader</code> 这样的方法，十分繁琐。</li><li><strong>控制自定义插件的顺序</strong>。开发者对于 Lavas 内部使用的插件缺少便捷的引用方式，因此无法插入新插件到某个特定插件前后。另外，如果想删除 Lavas 内置的某个插件，也只能通过索引方式访问插件数组。</li><li><strong>干预 Lavas 内置插件的初始化创建</strong>。对于 Lavas 内置的插件，一旦用户希望修改传入这个插件构造函数的参数，使用 <code>extend</code> 是无法做到的，因为调用 <code>extend</code> 时插件已经由 Lavas 初始化完成。</li></ol><p>而使用 <code>extendWithWebpackChain</code> 可以解决上述三个问题，方法参数和 <code>extend</code> 相同。</p><h3 data-hash=\"#扩展-lavas-内置规则及-loader\"><a href=\"#扩展-lavas-内置规则及-loader\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>扩展 Lavas 内置规则及 Loader</h3><p>首先，我们给 Lavas 内置的所有规则设置了名称，某条规则应用的任何一个 Loader 都可以通过 <code>config.rule(规则名称).use(Loader 名称)</code> 方式引用，并使用 <a href=\"https://github.com/mozilla-neutrino/webpack-chain#config-module-rules-uses-loaders-modifying-options\">tap</a> 方法对传入 Loader 的参数进行扩展：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div></div><code class=\"lang-javascript\">extendWithWebpackChain: <span class=\"hljs-function\">(<span class=\"hljs-params\">config, {type, env}</span>) =&gt;</span> {\n <span class=\"hljs-comment\">// 扩展 babel-loader，添加一个 babel 插件</span>\n config.module\n .rule(<span class=\"hljs-string\">'js'</span>)\n .use(<span class=\"hljs-string\">'babel'</span>)\n .tap(<span class=\"hljs-function\"><span class=\"hljs-params\">options</span> =&gt;</span> merge(options, { <span class=\"hljs-attr\">plugins</span>: [<span class=\"hljs-string\">'babel-plugin-syntax-object-rest-spread'</span>] }));\n}</code></pre><p>Lavas 内置的全部规则及对应 Loader 如下：</p><table><thead><tr><th>规则</th><th>Loader 名称</th><th>说明</th></tr></thead><tbody><tr><td>vue</td><td>vue</td><td>匹配 <code>/\\.vue$/</code> 规则</td></tr><tr><td>js</td><td>babel</td><td>匹配 <code>/\\.js$/</code> 规则，默认使用 <a href=\"https://github.com/vuejs/babel-preset-vue-app\">vue-app</a> preset</td></tr><tr><td>img</td><td>url</td><td>处理 <code>.png .jpe?g .gif .svg</code></td></tr><tr><td>font</td><td>url</td><td>处理 <code>.woff2 .eot .ttf .otf</code></td></tr><tr><td>style-css</td><td>css</td><td>匹配 <code>/\\.css$/</code> 规则</td></tr><tr><td>style-postcss</td><td>css</td><td>---</td></tr><tr><td>style-less</td><td>css less vue-style</td><td>匹配 <code>/\\.less$/</code> 规则，依次通过 css less 和 vue-style 这三个 Loader 处理，下同</td></tr><tr><td>style-sass</td><td>css sass vue-style</td><td>匹配 <code>/\\.sass$/</code> 规则</td></tr><tr><td>style-scss</td><td>css sass vue-style</td><td>匹配 <code>/\\.scss$/</code> 规则</td></tr><tr><td>style-stylus</td><td>css stylus vue-style</td><td>匹配 <code>/\\.stylus$/</code> 规则</td></tr><tr><td>style-styl</td><td>css stylus vue-style</td><td>匹配 <code>/\\.styl$/</code> 规则</td></tr></tbody></table><h3 data-hash=\"#扩展-lavas-内置插件\"><a href=\"#扩展-lavas-内置插件\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>扩展 Lavas 内置插件</h3><p>其次，我们给 Lavas 内部使用的所有插件也设置了名称，可以通过 <code>config.plugin(name)</code> 方式访问，通过以下方法可以对插件进行便捷地修改：</p><ul><li><a href=\"https://github.com/mozilla-neutrino/webpack-chain#config-plugins-modify-instantiation\">init</a> 扩展已有插件初始化参数</li><li><a href=\"https://github.com/mozilla-neutrino/webpack-chain#config-plugins-adding\">use</a> 添加新插件</li><li><a href=\"https://github.com/mozilla-neutrino/webpack-chain#config-plugins-ordering-after\">after/before</a> 控制新插件添加到已有插件前后</li></ul><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div></div><code class=\"lang-javascript\">extendWithWebpackChain: <span class=\"hljs-function\">(<span class=\"hljs-params\">config, {type, env}</span>) =&gt;</span> {\n <span class=\"hljs-comment\">// 在 friendly-error 插件创建时扩展自定义参数</span>\n config.plugin(<span class=\"hljs-string\">'friendly-error'</span>).init(<span class=\"hljs-function\">(<span class=\"hljs-params\">Plugin, args</span>) =&gt;</span> {\n <span class=\"hljs-keyword\">let</span> customParams = {}; <span class=\"hljs-comment\">// 扩展传入插件构造函数的参数</span>\n <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Plugin(...args, customParams)\n });\n\n <span class=\"hljs-comment\">// 添加第三方插件到指定 Lavas 内置 html 插件之后</span>\n config.plugin(<span class=\"hljs-string\">'my-plugin'</span>).after(<span class=\"hljs-string\">'html'</span>).use(MyPlugin);\n}</code></pre><p>以下是 Lavas 内置的部分插件列表：</p><table><thead><tr><th>插件名称</th><th>client/server</th><th>开发/生产环境</th><th>说明</th></tr></thead><tbody><tr><td>define</td><td>client &amp; server</td><td>开发 &amp; 生产</td><td><a href=\"https://doc.webpack-china.org/plugins/define-plugin/\">DefinePlugin</a>，可以通过 <a href=\"https://lavas.baidu.com/guide/v2/advanced/build-config#defines\"><code>build.defines</code></a> 进行扩展。</td></tr><tr><td>html</td><td>client</td><td>开发 &amp; 生产</td><td><a href=\"https://doc.webpack-china.org/plugins/html-webpack-plugin/\">HtmlWebpackPlugin</a>，用于在 SPA 模式下生成 HTML。</td></tr><tr><td>skeleton</td><td>client</td><td>开发 &amp; 生产</td><td><a href=\"https://github.com/lavas-project/vue-skeleton-webpack-plugin\">VueSkeletonWebpackPlugin</a>，用于在 SPA 模式下向 HTML 中注入 Skeleton。</td></tr><tr><td>chunk-vendor</td><td>client</td><td>开发 &amp; 生产</td><td><a href=\"https://doc.webpack-china.org/plugins/commons-chunk-plugin/\">CommonsChunkPlugin</a>，创建包含第三方依赖的 chunk</td></tr><tr><td>chunk-vue</td><td>client</td><td>开发 &amp; 生产</td><td>包含 vue，vuex，vue-router 和 vue-meta</td></tr><tr><td>chunk-manifest</td><td>client</td><td>开发 &amp; 生产</td><td>仅包含 Webpack 运行时代码</td></tr><tr><td>hot-module-replacement</td><td>client</td><td>开发</td><td>代码热更新相关</td></tr><tr><td>no-emit-on-errors</td><td>client</td><td>开发</td><td>出错时终止编译流程</td></tr><tr><td>progress-bar</td><td>client</td><td>开发</td><td><a href=\"https://github.com/clessg/progress-bar-webpack-plugin\">ProgressBarWebpackPlugin</a>，展示构建进度条</td></tr><tr><td>friendly-error</td><td>client</td><td>开发</td><td><a href=\"https://github.com/geowarin/friendly-errors-webpack-plugin\">FriendlyErrorsWebpackPlugin</a>，友好地展示错误信息</td></tr><tr><td>extract-css</td><td>client &amp; server</td><td>生产</td><td><a href=\"https://doc.webpack-china.org/plugins/extract-text-webpack-plugin/\">ExtractTextWebpackPlugin</a>，默认在开发模式关闭，生产环境开启。可以通过<a href=\"https://lavas.baidu.com/guide/v2/advanced/build-config#cssextract\"><code>build.cssExtract</code></a>配置。</td></tr><tr><td>module-concatenation</td><td>client &amp; server</td><td>生产</td><td><a href=\"https://doc.webpack-china.org/plugins/module-concatenation-plugin/\">ModuleConcatenationWebpackPlugin</a>，实现预编译功能</td></tr><tr><td>hashed-module-ids</td><td>client &amp; server</td><td>生产</td><td><a href=\"https://doc.webpack-china.org/plugins/hashed-module-ids-plugin/\">HashedModuleIdsWebpackPlugin</a>，根据模块的相对路径生成模块 id</td></tr><tr><td>optimize-css</td><td>client &amp; server</td><td>生产</td><td><a href=\"https://github.com/NMFR/optimize-css-assets-webpack-plugin\">OptimizeCSSPlugin</a>，样式去重压缩</td></tr><tr><td>uglify-js</td><td>client &amp; server</td><td>生产</td><td><a href=\"https://doc.webpack-china.org/plugins/uglifyjs-webpack-plugin/\">UglifyjsWebpackPlugin</a>，JS 压缩</td></tr><tr><td>workbox</td><td>client</td><td>生产</td><td><a href=\"https://github.com/GoogleChrome/workbox\">WorkboxWebpackPlugin</a>，使用 2.x 版本，用于生成 ServiceWorker 文件</td></tr><tr><td>sw-register</td><td>client</td><td>生产</td><td><a href=\"https://github.com/lavas-project/sw-register-webpack-plugin\">SWRegisterWebpackPlugin</a>，用于向 HTML 中注入 ServiceWorker 注册代码</td></tr></tbody></table><h3 data-hash=\"#更多示例\"><a href=\"#更多示例\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>更多示例</h3><p>上面列出了最常用的对于 Webpack 的扩展，即修改 Loader 和 插件，其余配置项的使用方法，可以参考 <a href=\"https://github.com/mozilla-neutrino/webpack-chain\">webpack-chain API</a>。</p><p>另外，我们编写了一个简单的 <a href=\"https://lavas.baidu.com/codelab/eslint/\">Codelab</a>，使用 <code>extendWithWebpackChain</code> 方法配合 ESlint 为 Lavas 项目增加代码检查。</p><h2 data-hash=\"#compress\"><a href=\"#compress\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>compress</h2><blockquote class=\"info\"><p>该配置项只有 SSR 模式下生效，SPA 模式下可以忽略。</p></blockquote><p>在 SSR 模式下是否启用 gzip，通过内置的 <a href=\"https://github.com/expressjs/compression\">compress 中间件</a>实现。Lavas 默认在开发模式中关闭这一特性，在生产环境打开。</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">compress: <span class=\"hljs-literal\">false</span></code></pre><h2 data-hash=\"#nodeexternalswhitelist\"><a href=\"#nodeexternalswhitelist\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>nodeExternalsWhitelist</h2><blockquote class=\"info\"><p>该配置项只有 SSR 模式下生效，SPA 模式下可以忽略。</p></blockquote><p>在 SSR 模式下，通常我们不希望将 <code>node_modules</code> 中的依赖打包进 server bundle 中，因此需要使用 Webpack <a href=\"https://doc.webpack-china.org/configuration/externals/\">externals</a> 配置项。Lavas 已经通过 <a href=\"https://github.com/liady/webpack-node-externals\">Webpack node modules externals</a> 将 <code>node_modules</code> 全部排除。但是在某些场景下，我们还是需要将部分特定的依赖打包进来，这时就需要使用<a href=\"https://github.com/liady/webpack-node-externals#optionswhitelist-\">白名单</a>了：</p><pre><div class=\"code-index\"><div>1</div></div><code class=\"lang-javascript\">nodeExternalsWhitelist: []</code></pre><p>例如在服务端渲染场景下常常遇到的一个问题是，某些第三方依赖使用了 <code>document</code>, <code>window</code> 这样在 Node.js 环境中不存在的对象。为了保证服务端渲染正常运行，通常使用 <code>resolve.alias</code> 引导 Webpack 使用空的 stub 对象，此时一定要同时在 <code>nodeExternalsWhitelist</code> 中加入该依赖。</p><h2 data-hash=\"#ssrcopy\"><a href=\"#ssrcopy\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>ssrCopy</h2><blockquote class=\"info\"><p>该配置项只有 SSR 模式下生效，SPA 模式下可以忽略。</p></blockquote><p>在 SSR 模式下，Lavas 除了将构建产物输出到例如 <code>dist</code> 文件夹中，还可以将例如 <code>node_modules</code>，线上脚本等文件拷贝到里面。这样 <code>dist</code> 文件夹可以作为一个可单独运行的包，移动到任意位置：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div></div><code class=\"lang-javascript\">ssrCopy: isDev ? [] : [\n {\n <span class=\"hljs-attr\">src</span>: <span class=\"hljs-string\">'server.prod.js'</span>\n },\n {\n <span class=\"hljs-attr\">src</span>: <span class=\"hljs-string\">'node_modules'</span>\n },\n {\n <span class=\"hljs-attr\">src</span>: <span class=\"hljs-string\">'package.json'</span>\n }\n]</code></pre><p>虽然从功能上看都是拷贝文件，但是这些文件并不会经过 CopyWebpackPlugin 处理，这一点不同于 <code>/static</code> 文件夹。</p><h2 data-hash=\"#watch\"><a href=\"#watch\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>watch</h2><p>Lavas 在开发模式下使用了 webpack-dev-middleware。得益于自带的热加载功能，很多源文件的修改会自动触发 Webpack 重新编译，不需要开发者重启开发服务器。Lavas 扩充了这个功能，修改以下文件，也会触发重新编译：</p><ul><li><code>/pages</code> 下增加删除修改路由组件。</li><li><code>lavas.config.js</code> 配置内容发生修改。</li><li>SSR 模式下模板内容发生修改。</li></ul><p>整个重新编译过程中不需要开发者关闭重启服务，也就是说从 MPA 模式切换到 SSR 模式也只需要修改配置后等待编译完成。另外，如果想监控自定义文件、文件夹，在它们发生修改时也触发重新编译，可以通过 <code>watch</code> 配置项传入文件列表：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div></div><code class=\"lang-javascript\">watch: [\n <span class=\"hljs-string\">'/foo/bar'</span> <span class=\"hljs-comment\">// 自定义文件</span>\n]</code></pre><h2 data-hash=\"#development-production\"><a href=\"#development-production\" class=\"heading-link\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></a>development &amp; production</h2><p>对于以上配置项，如果需要在开发模式和生产环境启用不同的值，可以使用两个特殊的配置项 <code>development</code> 和 <code>production</code>。 例如想在开发模式关闭 <code>cssExtract</code> 分离样式而在生产环境开启，可以这么做：</p><pre><div class=\"code-index\"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div></div><code class=\"lang-javascript\">build: {\n <span class=\"hljs-comment\">// 省略其他配置项</span>\n},\n<span class=\"hljs-attr\">development</span>: {\n <span class=\"hljs-attr\">build</span>: {\n <span class=\"hljs-attr\">cssExtract</span>: <span class=\"hljs-literal\">false</span>\n }\n},\n<span class=\"hljs-attr\">production</span>: {\n <span class=\"hljs-attr\">build</span>: {\n <span class=\"hljs-attr\">cssExtract</span>: <span class=\"hljs-literal\">true</span>\n }\n}</code></pre>\n <div class=\"md-related-wrapper\">\n <a class=\"md-related to-edit ui-dep-2\" href=\"https://github.com/lavas-project/lavas-tutorial/edit/master/v2/advanced/build-config.md\" target=\"_blank\">\n <div class=\"md-ripple\"></div>\n <i class=\"material-icons\">mode_edit</i>编辑\n </a>\n <a class=\"md-related to-feedback ui-dep-2\"\n target=\"_blank\"\n href=\"https://github.com/lavas-project/lavas-tutorial/issues/new?title=反馈：v2/advanced/build-config.md\"\n >\n <div class=\"md-ripple\"></div>\n <i class=\"material-icons\">feedback</i>反馈\n </a>\n <div class=\"md-related like-box\">\n 这篇文章对您有帮助吗？\n <span class=\"like\">\n <i class=\"material-icons\">thumb_up</i>\n </span>\n <span class=\"unlike\">\n <i class=\"material-icons\">thumb_down</i>\n </span>\n </div>\n </div>\n